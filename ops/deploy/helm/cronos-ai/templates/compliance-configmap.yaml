{{- if .Values.compliance.enabled }}
# CRONOS AI - Compliance Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "cronos-ai.fullname" . }}-compliance-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "cronos-ai.labels" . | nindent 4 }}
    app.kubernetes.io/component: compliance
data:
  compliance.yaml: |
    # CRONOS AI Compliance Module Configuration - Production
    
    environment: {{ .Values.global.environment }}
    service_name: {{ include "cronos-ai.fullname" . }}-compliance
    version: {{ .Chart.AppVersion }}
    
    # Assessment Configuration
    compliance:
      enabled: {{ .Values.compliance.enabled }}
      assessment_interval_hours: {{ .Values.compliance.assessment.intervalHours }}
      max_concurrent_assessments: {{ .Values.compliance.assessment.maxConcurrentAssessments }}
      cache_enabled: {{ .Values.compliance.assessment.cacheEnabled }}
      cache_ttl_hours: {{ .Values.compliance.assessment.cacheTtlHours }}
      
      # Supported Frameworks
      supported_frameworks:
        {{- range .Values.compliance.frameworks }}
        - {{ . }}
        {{- end }}
      
      # Framework Configurations
      framework_configs:
        PCI_DSS_4_0:
          version: "4.0"
          requirements_count: 12
          sub_requirements_count: 64
          criticality_weights:
            critical: 1.0
            high: 0.8
            medium: 0.6
            low: 0.4
        
        BASEL_III:
          version: "3.0"
          pillar_count: 3
          requirements_count: 28
          criticality_weights:
            critical: 1.0
            high: 0.9
            medium: 0.7
            low: 0.5
        
        HIPAA:
          version: "2013"
          safeguard_types: ["administrative", "physical", "technical"]
          requirements_count: 18
          criticality_weights:
            critical: 1.0
            high: 0.8
            medium: 0.6
            low: 0.4
        
        NERC_CIP:
          version: "5"
          standards_count: 11
          requirements_count: 45
          criticality_weights:
            critical: 1.0
            high: 0.9
            medium: 0.7
            low: 0.5
        
        FDA_MEDICAL:
          version: "2022"
          device_classes: ["I", "II", "III"]
          requirements_count: 35
          criticality_weights:
            critical: 1.0
            high: 0.85
            medium: 0.65
            low: 0.45
    
    # Report Generation Configuration
    reports:
      enabled: true
      output_formats:
        {{- range .Values.compliance.reports.formats }}
        - {{ . }}
        {{- end }}
      retention_days: {{ .Values.compliance.reports.retention.days }}
      encryption:
        enabled: {{ .Values.compliance.reports.encryption.enabled }}
        algorithm: {{ .Values.compliance.reports.encryption.algorithm }}
      templates:
        executive_summary: "templates/executive_summary.j2"
        detailed_technical: "templates/detailed_technical.j2"
        gap_analysis: "templates/gap_analysis.j2"
        remediation_plan: "templates/remediation_plan.j2"
      
      # Template Settings
      template_settings:
        company_name: "{{ .Values.global.companyName | default "Your Organization" }}"
        company_logo: "/app/compliance/assets/logo.png"
        contact_email: "{{ .Values.global.contactEmail | default "compliance@example.com" }}"
        footer_text: "Confidential and Proprietary - Not for Distribution"
    
    # Audit Trail Configuration
    audit_trail:
      enabled: {{ .Values.compliance.auditTrail.enabled }}
      blockchain:
        enabled: {{ .Values.compliance.auditTrail.blockchain.enabled }}
        network_type: {{ .Values.compliance.auditTrail.blockchain.network }}
        consensus_algorithm: "proof_of_authority"
        block_time_seconds: 15
        max_transactions_per_block: 1000
      retention_days: {{ .Values.compliance.auditTrail.retention.days }}
      encryption:
        enabled: {{ .Values.compliance.auditTrail.encryption.enabled }}
        algorithm: "AES-256-GCM"
      
      # Event Types to Audit
      audit_events:
        - assessment_started
        - assessment_completed
        - report_generated
        - configuration_changed
        - user_action
        - system_event
        - data_access
        - compliance_violation
    
    # LLM Service Configuration
    llm:
      primary_provider: {{ .Values.compliance.llm.primary.provider }}
      primary_model: {{ .Values.compliance.llm.primary.model }}
      primary_max_tokens: {{ .Values.compliance.llm.primary.maxTokens }}
      primary_temperature: {{ .Values.compliance.llm.primary.temperature }}
      
      fallback_provider: {{ .Values.compliance.llm.fallback.provider }}
      fallback_model: {{ .Values.compliance.llm.fallback.model }}
      fallback_max_tokens: {{ .Values.compliance.llm.fallback.maxTokens }}
      fallback_temperature: {{ .Values.compliance.llm.fallback.temperature }}
      
      # Request Settings
      timeout_seconds: 30
      max_retries: 3
      retry_delay_seconds: 2
      
      # Content Filtering
      content_filter:
        enabled: true
        max_input_length: 50000
        blocked_patterns:
          - "personal_data_pattern"
          - "financial_data_pattern"
      
      # Feature Routing
      feature_routing:
        compliance_reporter: {{ .Values.compliance.llm.primary.provider }}
        gap_analysis: {{ .Values.compliance.llm.primary.provider }}
        remediation_planning: {{ .Values.compliance.llm.primary.provider }}
    
    # Data Integration Configuration
    data_integration:
      timescaledb:
        enabled: {{ .Values.compliance.dataIntegration.timescaledb.enabled }}
        host: "{{ .Values.postgresql.primary.service.name }}"
        port: 5432
        database: "{{ .Values.postgresql.auth.database }}"
        schema: "compliance"
        retention_policy: {{ .Values.compliance.dataIntegration.timescaledb.retentionPolicy }}
        
        # Table Configurations
        tables:
          assessments:
            hypertable: true
            time_column: "created_at"
            chunk_time_interval: "1 day"
          audit_events:
            hypertable: true
            time_column: "event_timestamp"
            chunk_time_interval: "1 hour"
          compliance_metrics:
            hypertable: true
            time_column: "metric_timestamp"
            chunk_time_interval: "6 hours"
      
      redis:
        enabled: {{ .Values.compliance.dataIntegration.redis.enabled }}
        host: "{{ .Values.redis.master.service.name }}"
        port: 6379
        database: 2  # Dedicated DB for compliance
        key_prefix: {{ .Values.compliance.dataIntegration.redis.keyPrefix }}
        default_ttl: {{ .Values.compliance.dataIntegration.redis.ttl }}
        
        # Key Patterns
        key_patterns:
          assessment_cache: "compliance:assessment:{framework}:{hash}"
          framework_data: "compliance:framework:{name}"
          report_cache: "compliance:report:{type}:{framework}:{hash}"
          user_sessions: "compliance:session:{user_id}"
      
      security_integration:
        enabled: {{ .Values.compliance.dataIntegration.security.enabled }}
        event_types:
          {{- range .Values.compliance.dataIntegration.security.eventTypes }}
          - {{ . }}
          {{- end }}
        
        # SIEM Integration
        siem:
          enabled: true
          endpoint: "http://security-analyzer-service:8080/api/v1/events"
          authentication:
            type: "bearer_token"
            token_secret: "cronos-ai-secrets"
            token_key: "siem-api-token"
    
    # Monitoring and Alerting
    monitoring:
      enabled: {{ .Values.compliance.monitoring.enabled }}
      metrics_enabled: {{ .Values.compliance.monitoring.metrics.enabled }}
      prometheus_namespace: {{ .Values.compliance.monitoring.metrics.prometheusNamespace }}
      
      # Health Checks
      health_checks:
        enabled: true
        interval_seconds: 30
        timeout_seconds: 5
        
        # Component Health Checks
        components:
          - llm_service
          - database
          - redis
          - audit_trail
          - report_generator
      
      # Alerting Configuration
      alerts:
        enabled: {{ .Values.compliance.monitoring.alerts.enabled }}
        critical_gap_threshold: {{ .Values.compliance.monitoring.alerts.criticalGapThreshold }}
        compliance_score_threshold: {{ .Values.compliance.monitoring.alerts.complianceScoreThreshold }}
        
        # Alert Channels
        channels:
          - type: "prometheus"
            enabled: true
          - type: "webhook"
            enabled: true
            url: "http://alertmanager:9093/api/v1/alerts"
    
    # Security Configuration
    security:
      encryption:
        enabled: {{ .Values.compliance.security.encryption.enabled }}
        algorithm: {{ .Values.compliance.security.encryption.algorithm }}
        key_rotation_days: 90
        
        # Encryption Contexts
        contexts:
          reports: "compliance-reports"
          audit_trail: "compliance-audit"
          assessment_data: "compliance-assessments"
      
      access_control:
        enabled: {{ .Values.compliance.security.accessControl.enabled }}
        rbac_enabled: {{ .Values.compliance.security.accessControl.rbac }}
        
        # Role Definitions
        roles:
          compliance_admin:
            permissions: ["*"]
          compliance_analyst:
            permissions: ["assess", "report:read", "dashboard:read"]
          compliance_viewer:
            permissions: ["report:read", "dashboard:read"]
          auditor:
            permissions: ["audit:read", "report:read"]
      
      data_classification:
        enabled: {{ .Values.compliance.security.dataClassification.enabled }}
        levels:
          {{- range .Values.compliance.security.dataClassification.levels }}
          - {{ . }}
          {{- end }}
        
        # Classification Rules
        rules:
          - pattern: "*password*"
            level: "RESTRICTED"
          - pattern: "*ssn*"
            level: "RESTRICTED"
          - pattern: "*compliance*"
            level: "CONFIDENTIAL"
          - pattern: "*assessment*"
            level: "INTERNAL"
    
    # Enterprise Features
    enterprise:
      multi_tenancy:
        enabled: {{ .Values.compliance.enterprise.multiTenancy.enabled }}
        tenant_isolation: "schema"
        default_tenant: "default"
      
      custom_frameworks:
        enabled: {{ .Values.compliance.enterprise.customFrameworks.enabled }}
        max_custom_frameworks: 10
        validation_required: true
      
      api_rate_limiting:
        enabled: {{ .Values.compliance.enterprise.apiRateLimit.enabled }}
        requests_per_minute: {{ .Values.compliance.enterprise.apiRateLimit.requestsPerMinute }}
        burst_limit: 200
        
        # Rate Limit Exemptions
        exemptions:
          - "system-monitor"
          - "health-check"
      
      sla:
        assessment_time_seconds: {{ .Values.compliance.enterprise.sla.assessmentTime }}
        report_generation_seconds: {{ .Values.compliance.enterprise.sla.reportGeneration }}
        uptime_percentage: 99.9
        response_time_p95_ms: 2000
    
    # Logging Configuration
    logging:
      level: {{ .Values.global.logLevel | default "INFO" }}
      format: "structured"
      output: "stdout"
      
      # Log Categories
      categories:
        compliance: "INFO"
        llm_service: "INFO"
        audit_trail: "DEBUG"
        security: "WARN"
        performance: "INFO"
      
      # Sensitive Data Filtering
      sensitive_fields:
        - "password"
        - "token"
        - "key"
        - "secret"
        - "ssn"
        - "credit_card"
{{- end }}