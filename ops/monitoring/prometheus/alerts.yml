# QBITEL - Prometheus Alerting Rules
groups:
  - name: legacy-whisperer-application
    rules:
      - alert: LegacyWhispererDown
        expr: up{job="legacy-whisperer"} == 0
        for: 2m
        labels:
          severity: critical
          service: legacy-whisperer
        annotations:
          summary: "Legacy System Whisperer is down"
          description: "Legacy System Whisperer has been unreachable for more than 2 minutes."

      - alert: LegacyWhispererHighErrorRate
        expr: (sum(rate(qbitel_legacy_requests_total{status=~"5.."}[5m])) / sum(rate(qbitel_legacy_requests_total[5m]))) > 0.05
        for: 5m
        labels:
          severity: warning
          service: legacy-whisperer
        annotations:
          summary: "High error rate in Legacy System Whisperer"
          description: "Error rate is above 5% threshold"

      - alert: LegacyWhispererHighLatency
        expr: histogram_quantile(0.95, sum(rate(qbitel_legacy_request_duration_seconds_bucket[5m])) by (le)) > 2
        for: 5m
        labels:
          severity: warning
          service: legacy-whisperer
        annotations:
          summary: "High latency in Legacy System Whisperer"
          description: "P95 latency is above 2 seconds threshold"

  - name: llm-service
    rules:
      - alert: AllLLMProvidersDown
        expr: sum(qbitel_llm_provider_health) == 0
        for: 2m
        labels:
          severity: critical
          service: llm-service
        annotations:
          summary: "All LLM providers are down"
          description: "No LLM providers are available. AI features are offline."

      - alert: HighLLMTokenUsage
        expr: sum(rate(qbitel_llm_tokens_total[1h])) > 100000
        for: 30m
        labels:
          severity: warning
          service: llm-service
        annotations:
          summary: "High LLM token usage"
          description: "Token usage is very high"

  - name: database
    rules:
      - alert: PostgresDown
        expr: pg_up == 0
        for: 2m
        labels:
          severity: critical
          service: postgres
        annotations:
          summary: "PostgreSQL is down"
          description: "PostgreSQL has been unreachable for more than 2 minutes."

      - alert: DatabaseConnectionPoolExhausted
        expr: (pg_stat_activity_count / pg_settings_max_connections) > 0.8
        for: 5m
        labels:
          severity: warning
          service: postgres
        annotations:
          summary: "Database connection pool near exhaustion"
          description: "Connection pool usage is above 80%"

  - name: redis
    rules:
      - alert: RedisDown
        expr: redis_up == 0
        for: 2m
        labels:
          severity: critical
          service: redis
        annotations:
          summary: "Redis is down"
          description: "Redis has been unreachable for more than 2 minutes."

      - alert: RedisHighMemoryUsage
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
        for: 10m
        labels:
          severity: warning
          service: redis
        annotations:
          summary: "Redis memory usage high"
          description: "Memory usage is above 90%"

  - name: zero-touch-security
    rules:
      - alert: ZeroTouchDecisionEngineDown
        expr: up{job="zero-touch-security"} == 0
        for: 1m
        labels:
          severity: critical
          service: zero-touch-security
        annotations:
          summary: "Zero-Touch Security Decision Engine is down"
          description: "The autonomous security decision engine has been unreachable for more than 1 minute. Security automation is offline."

      - alert: ZeroTouchHighEscalationRate
        expr: (sum(rate(qbitel_security_decisions_total{decision_type="escalate"}[15m])) / sum(rate(qbitel_security_decisions_total[15m]))) > 0.3
        for: 15m
        labels:
          severity: warning
          service: zero-touch-security
        annotations:
          summary: "High escalation rate in Zero-Touch Security"
          description: "More than 30% of security decisions are being escalated to humans. Check confidence thresholds or LLM availability."

      - alert: ZeroTouchSlowResponseTime
        expr: histogram_quantile(0.95, sum(rate(qbitel_security_decision_duration_seconds_bucket[5m])) by (le)) > 5
        for: 5m
        labels:
          severity: warning
          service: zero-touch-security
        annotations:
          summary: "Slow Zero-Touch Security response time"
          description: "P95 decision latency exceeds 5 seconds. Security response SLA may be at risk."

      - alert: ZeroTouchCriticalThreatUnhandled
        expr: increase(qbitel_security_decisions_total{confidence_level="critical",decision_type="escalate"}[5m]) > 5
        for: 2m
        labels:
          severity: critical
          service: zero-touch-security
        annotations:
          summary: "Multiple critical threats escalated"
          description: "5+ critical security threats have been escalated in the last 5 minutes. Immediate human review required."

      - alert: ZeroTouchHighFailureRate
        expr: (sum(rate(qbitel_zero_touch_api_requests_total{status="error"}[5m])) / sum(rate(qbitel_zero_touch_api_requests_total[5m]))) > 0.05
        for: 5m
        labels:
          severity: warning
          service: zero-touch-security
        annotations:
          summary: "High error rate in Zero-Touch Security API"
          description: "Error rate is above 5% threshold. Check service logs and dependencies."

      - alert: ZeroTouchPendingApprovalsBacklog
        expr: qbitel_zero_touch_pending_approvals > 20
        for: 30m
        labels:
          severity: warning
          service: zero-touch-security
        annotations:
          summary: "Large backlog of pending security approvals"
          description: "More than 20 security actions are awaiting manual approval. Human review capacity may be insufficient."

      - alert: ZeroTouchCircuitBreakerOpen
        expr: qbitel_circuit_breaker_state{name="llm"} == 1
        for: 2m
        labels:
          severity: critical
          service: zero-touch-security
        annotations:
          summary: "LLM circuit breaker is open"
          description: "The LLM service circuit breaker is open. Zero-touch decision making is degraded to fallback mode."

      - alert: ZeroTouchHighThreatVolume
        expr: sum(rate(qbitel_security_events_total{severity=~"high|critical"}[5m])) > 10
        for: 5m
        labels:
          severity: warning
          service: zero-touch-security
        annotations:
          summary: "High volume of severe security threats"
          description: "Receiving more than 10 high/critical severity security events per minute. Possible attack in progress."

      - alert: ZeroTouchAutoExecutionSpike
        expr: increase(qbitel_security_auto_executions[5m]) > 50
        for: 2m
        labels:
          severity: warning
          service: zero-touch-security
        annotations:
          summary: "Spike in automated security responses"
          description: "More than 50 automated security actions executed in 5 minutes. Verify this is not a false positive cascade."

      - alert: ZeroTouchLowConfidenceDecisions
        expr: (sum(rate(qbitel_security_decisions_total{confidence_level="low"}[30m])) / sum(rate(qbitel_security_decisions_total[30m]))) > 0.5
        for: 30m
        labels:
          severity: warning
          service: zero-touch-security
        annotations:
          summary: "Majority of decisions have low confidence"
          description: "More than 50% of security decisions have low confidence. Check threat intelligence data and LLM performance."

  - name: infrastructure
    rules:
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 10m
        labels:
          severity: warning
          service: infrastructure
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is above 80%"

      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 10m
        labels:
          severity: warning
          service: infrastructure
        annotations:
          summary: "High memory usage"
          description: "Memory usage is above 85%"

      - alert: DiskSpaceLow
        expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100 > 85
        for: 30m
        labels:
          severity: warning
          service: infrastructure
        annotations:
          summary: "Low disk space"
          description: "Disk usage is above 85%"
