groups:
  - name: qbitelai.critical
    interval: 30s
    rules:
      # Service availability alerts
      - alert: QbitelAIServiceDown
        expr: up{job=~"qbitelai-.*"} == 0
        for: 1m
        labels:
          severity: critical
          component: "{{ $labels.job }}"
        annotations:
          summary: "QBITEL service {{ $labels.job }} is down"
          description: "Service {{ $labels.job }} on {{ $labels.instance }} has been down for more than 1 minute"
          runbook_url: "https://runbooks.qbitel.io/service-down"

      # High error rate alerts
      - alert: QbitelAIHighErrorRate
        expr: |
          (
            rate(qbitelai_requests_total{status=~"5.."}[5m]) /
            rate(qbitelai_requests_total[5m])
          ) * 100 > 5
        for: 2m
        labels:
          severity: critical
          component: "{{ $labels.service }}"
        annotations:
          summary: "High error rate detected in {{ $labels.service }}"
          description: "Error rate is {{ $value | humanizePercentage }} for service {{ $labels.service }}"
          runbook_url: "https://runbooks.qbitelai.io/high-error-rate"

      # High latency alerts
      - alert: QbitelAIHighLatency
        expr: |
          histogram_quantile(0.95,
            rate(qbitelai_request_duration_seconds_bucket[5m])
          ) > 0.5
        for: 3m
        labels:
          severity: critical
          component: "{{ $labels.service }}"
        annotations:
          summary: "High latency detected in {{ $labels.service }}"
          description: "95th percentile latency is {{ $value | humanizeDuration }} for service {{ $labels.service }}"
          runbook_url: "https://runbooks.qbitelai.io/high-latency"

      # Memory usage alerts
      - alert: QbitelAIHighMemoryUsage
        expr: |
          (
            process_resident_memory_bytes{job=~"qbitelai-.*"} /
            node_memory_MemTotal_bytes
          ) * 100 > 80
        for: 5m
        labels:
          severity: critical
          component: "{{ $labels.job }}"
        annotations:
          summary: "High memory usage in {{ $labels.job }}"
          description: "Memory usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}"
          runbook_url: "https://runbooks.qbitelai.io/high-memory"

      # CPU usage alerts
      - alert: QbitelAIHighCPUUsage
        expr: |
          rate(process_cpu_seconds_total{job=~"qbitelai-.*"}[5m]) * 100 > 80
        for: 5m
        labels:
          severity: critical
          component: "{{ $labels.job }}"
        annotations:
          summary: "High CPU usage in {{ $labels.job }}"
          description: "CPU usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}"
          runbook_url: "https://runbooks.qbitelai.io/high-cpu"

      # Connection pool exhaustion
      - alert: QbitelAIConnectionPoolExhausted
        expr: |
          qbitelai_connection_pool_active / qbitelai_connection_pool_max > 0.9
        for: 2m
        labels:
          severity: critical
          component: "connection-pool"
        annotations:
          summary: "Connection pool nearly exhausted"
          description: "Connection pool utilization is {{ $value | humanizePercentage }} on {{ $labels.instance }}"
          runbook_url: "https://runbooks.qbitelai.io/connection-pool-exhausted"

  - name: qbitelai.warning
    interval: 60s
    rules:
      # Moderate error rate
      - alert: QbitelAIModerateErrorRate
        expr: |
          (
            rate(qbitelai_requests_total{status=~"5.."}[5m]) /
            rate(qbitelai_requests_total[5m])
          ) * 100 > 1
        for: 5m
        labels:
          severity: warning
          component: "{{ $labels.service }}"
        annotations:
          summary: "Moderate error rate in {{ $labels.service }}"
          description: "Error rate is {{ $value | humanizePercentage }} for service {{ $labels.service }}"

      # Moderate latency
      - alert: QbitelAIModerateLatency
        expr: |
          histogram_quantile(0.95,
            rate(qbitelai_request_duration_seconds_bucket[5m])
          ) > 0.2
        for: 5m
        labels:
          severity: warning
          component: "{{ $labels.service }}"
        annotations:
          summary: "Moderate latency in {{ $labels.service }}"
          description: "95th percentile latency is {{ $value | humanizeDuration }} for service {{ $labels.service }}"

      # Certificate expiration
      - alert: QbitelAICertificateExpiringSoon
        expr: |
          (qbitelai_certificate_expiry_timestamp - time()) / 86400 < 30
        for: 1h
        labels:
          severity: warning
          component: "certificates"
        annotations:
          summary: "Certificate expiring soon"
          description: "Certificate {{ $labels.certificate_id }} expires in {{ $value }} days"
          runbook_url: "https://runbooks.qbitelai.io/certificate-expiry"

      # Device health issues
      - alert: QbitelAIDeviceHealthDegraded
        expr: |
          qbitelai_device_health_status{status!="healthy"} > 0
        for: 10m
        labels:
          severity: warning
          component: "device-management"
        annotations:
          summary: "Device health degraded"
          description: "Device {{ $labels.device_id }} has health status {{ $labels.status }}"

      # Policy engine issues
      - alert: QbitelAIPolicyEvaluationSlow
        expr: |
          histogram_quantile(0.95,
            rate(qbitelai_policy_evaluation_duration_seconds_bucket[5m])
          ) > 0.01
        for: 5m
        labels:
          severity: warning
          component: "policy-engine"
        annotations:
          summary: "Policy evaluation is slow"
          description: "95th percentile policy evaluation time is {{ $value | humanizeDuration }}"

  - name: qbitelai.security
    interval: 30s
    rules:
      # Failed authentication attempts
      - alert: QbitelAIHighFailedAuthRate
        expr: |
          rate(qbitelai_auth_failures_total[5m]) > 10
        for: 2m
        labels:
          severity: critical
          component: "authentication"
        annotations:
          summary: "High authentication failure rate"
          description: "Authentication failure rate is {{ $value }} per second"
          runbook_url: "https://runbooks.qbitelai.io/auth-failures"

      # TPM attestation failures
      - alert: QBITELTPMAttestationFailures
        expr: |
          rate(qbitel_tpm_attestation_failures_total[5m]) > 1
        for: 1m
        labels:
          severity: critical
          component: "tpm-attestation"
        annotations:
          summary: "TPM attestation failures detected"
          description: "TPM attestation failure rate is {{ $value }} per second"
          runbook_url: "https://runbooks.qbitelai.io/tpm-failures"

      # Certificate validation failures
      - alert: QbitelAICertValidationFailures
        expr: |
          rate(qbitelai_cert_validation_failures_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
          component: "certificate-validation"
        annotations:
          summary: "Certificate validation failures"
          description: "Certificate validation failure rate is {{ $value }} per second"

      # Suspicious device behavior
      - alert: QbitelAISuspiciousDeviceBehavior
        expr: |
          qbitelai_device_compliance_violations_total > 0
        for: 1m
        labels:
          severity: critical
          component: "device-compliance"
        annotations:
          summary: "Device compliance violations detected"
          description: "Device {{ $labels.device_id }} has compliance violations: {{ $labels.violation_type }}"
          runbook_url: "https://runbooks.qbitelai.io/compliance-violations"

  - name: qbitelai.performance
    interval: 60s
    rules:
      # Throughput degradation
      - alert: QbitelAIThroughputDegraded
        expr: |
          rate(qbitelai_bytes_processed_total[5m]) < 1000000  # Less than 1MB/s
        for: 5m
        labels:
          severity: warning
          component: "dataplane"
        annotations:
          summary: "Throughput degraded"
          description: "Current throughput is {{ $value | humanizeBytes }}/s"

      # Connection count high
      - alert: QbitelAIHighConnectionCount
        expr: |
          qbitelai_connections_active > 10000
        for: 5m
        labels:
          severity: warning
          component: "connection-management"
        annotations:
          summary: "High connection count"
          description: "Active connections: {{ $value }}"

      # Circuit breaker open
      - alert: QbitelAICircuitBreakerOpen
        expr: |
          qbitelai_circuit_breaker_state{state="open"} > 0
        for: 1m
        labels:
          severity: warning
          component: "circuit-breaker"
        annotations:
          summary: "Circuit breaker is open"
          description: "Circuit breaker for {{ $labels.target }} is open"
          runbook_url: "https://runbooks.qbitelai.io/circuit-breaker"

      # Backpressure active
      - alert: QbitelAIBackpressureActive
        expr: |
          qbitelai_backpressure_active > 0
        for: 2m
        labels:
          severity: warning
          component: "backpressure"
        annotations:
          summary: "Backpressure is active"
          description: "Backpressure is active on {{ $labels.instance }}"

  - name: qbitelai.business
    interval: 300s
    rules:
      # SLA breach detection
      - alert: QbitelAISLABreach
        expr: |
          (
            rate(qbitelai_requests_total{status=~"2.."}[1h]) /
            rate(qbitelai_requests_total[1h])
          ) * 100 < 99.9
        for: 5m
        labels:
          severity: critical
          component: "sla"
        annotations:
          summary: "SLA breach detected"
          description: "Availability is {{ $value | humanizePercentage }} (below 99.9% SLA)"
          runbook_url: "https://runbooks.qbitelai.io/sla-breach"

      # Device enrollment rate anomaly
      - alert: QbitelAIDeviceEnrollmentAnomaly
        expr: |
          abs(
            rate(qbitelai_device_enrollments_total[1h]) -
            rate(qbitelai_device_enrollments_total[1h] offset 24h)
          ) / rate(qbitelai_device_enrollments_total[1h] offset 24h) > 0.5
        for: 10m
        labels:
          severity: warning
          component: "device-enrollment"
        annotations:
          summary: "Device enrollment rate anomaly"
          description: "Device enrollment rate has changed significantly compared to 24h ago"

      # Policy update failures
      - alert: QbitelAIPolicyUpdateFailures
        expr: |
          rate(qbitelai_policy_update_failures_total[1h]) > 0
        for: 5m
        labels:
          severity: warning
          component: "policy-management"
        annotations:
          summary: "Policy update failures"
          description: "Policy update failure rate is {{ $value }} per second"

  - name: qbitelai.capacity
    interval: 300s
    rules:
      # Disk space low
      - alert: QbitelAIDiskSpaceLow
        expr: |
          (
            node_filesystem_avail_bytes{mountpoint="/"} /
            node_filesystem_size_bytes{mountpoint="/"}
          ) * 100 < 10
        for: 5m
        labels:
          severity: critical
          component: "storage"
        annotations:
          summary: "Disk space low"
          description: "Available disk space is {{ $value | humanizePercentage }} on {{ $labels.instance }}"
          runbook_url: "https://runbooks.qbitelai.io/disk-space-low"

      # Network bandwidth utilization high
      - alert: QbitelAIHighNetworkUtilization
        expr: |
          rate(node_network_transmit_bytes_total[5m]) * 8 > 800000000  # 800 Mbps
        for: 5m
        labels:
          severity: warning
          component: "network"
        annotations:
          summary: "High network utilization"
          description: "Network transmit rate is {{ $value | humanizeBitsPerSec }} on {{ $labels.instance }}"

      # File descriptor usage high
      - alert: QbitelAIHighFileDescriptorUsage
        expr: |
          (
            process_open_fds{job=~"qbitelai-.*"} /
            process_max_fds{job=~"qbitelai-.*"}
          ) * 100 > 80
        for: 5m
        labels:
          severity: warning
          component: "file-descriptors"
        annotations:
          summary: "High file descriptor usage"
          description: "File descriptor usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}"

  - name: qbitelai.recording
    interval: 30s
    rules:
      # Request rate recording rules
      - record: qbitelai:request_rate_5m
        expr: rate(qbitelai_requests_total[5m])

      - record: qbitelai:request_rate_1h
        expr: rate(qbitelai_requests_total[1h])

      # Error rate recording rules
      - record: qbitelai:error_rate_5m
        expr: |
          rate(qbitelai_requests_total{status=~"5.."}[5m]) /
          rate(qbitelai_requests_total[5m])

      - record: qbitelai:error_rate_1h
        expr: |
          rate(qbitelai_requests_total{status=~"5.."}[1h]) /
          rate(qbitelai_requests_total[1h])

      # Latency recording rules
      - record: qbitelai:latency_p50_5m
        expr: |
          histogram_quantile(0.50,
            rate(qbitelai_request_duration_seconds_bucket[5m])
          )

      - record: qbitelai:latency_p95_5m
        expr: |
          histogram_quantile(0.95,
            rate(qbitelai_request_duration_seconds_bucket[5m])
          )

      - record: qbitelai:latency_p99_5m
        expr: |
          histogram_quantile(0.99,
            rate(qbitelai_request_duration_seconds_bucket[5m])
          )

      # Throughput recording rules
      - record: qbitelai:throughput_bytes_5m
        expr: rate(qbitelai_bytes_processed_total[5m])

      - record: qbitelai:throughput_requests_5m
        expr: rate(qbitelai_requests_total[5m])

      # Availability recording rules
      - record: qbitelai:availability_5m
        expr: |
          (
            rate(qbitelai_requests_total{status=~"2.."}[5m]) /
            rate(qbitelai_requests_total[5m])
          ) * 100

      - record: qbitelai:availability_1h
        expr: |
          (
            rate(qbitelai_requests_total{status=~"2.."}[1h]) /
            rate(qbitelai_requests_total[1h])
          ) * 100

      - record: qbitelai:availability_24h
        expr: |
          (
            rate(qbitelai_requests_total{status=~"2.."}[24h]) /
            rate(qbitelai_requests_total[24h])
          ) * 100

      # Resource utilization recording rules
      - record: qbitelai:cpu_utilization_5m
        expr: |
          rate(process_cpu_seconds_total{job=~"qbitelai-.*"}[5m]) * 100

      - record: qbitelai:memory_utilization_5m
        expr: |
          (
            process_resident_memory_bytes{job=~"qbitelai-.*"} /
            node_memory_MemTotal_bytes
          ) * 100

      # Device health recording rules
      - record: qbitelai:device_health_ratio
        expr: |
          (
            count(qbitelai_device_health_status{status="healthy"}) /
            count(qbitelai_device_health_status)
          ) * 100

      # Policy evaluation performance
      - record: qbitelai:policy_evaluation_p95_5m
        expr: |
          histogram_quantile(0.95,
            rate(qbitelai_policy_evaluation_duration_seconds_bucket[5m])
          )